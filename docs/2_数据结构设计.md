好的，这是一个非常清晰和全面的需求文档。基于 **Scintirete** 的核心理念（简单、轻量、生产导向），我将为您设计一套匹配的 Proto、服务端和客户端工具参数，以及 TOML 配置结构。

---

### 1. Protobuf 定义 (`scintirete/v1/scintirete.proto`)

这是系统的核心数据契约，定义了所有 gRPC 接口和数据结构。它清晰、强类型，并且是语言无关的。

```protobuf
syntax = "proto3";

package scintirete.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/empty.proto";

option go_package = "github.com/scintirete/scintirete/gen/go/scintirete/v1;scintiretev1";

// ===================================
// 主服务定义
// ===================================

// ScintireteService 定义了向量数据库的所有可操作接口
service ScintireteService {
  // --- 数据库管理 ---
  // 创建一个新的数据库
  rpc CreateDatabase(CreateDatabaseRequest) returns (google.protobuf.Empty);
  // 删除一个数据库及其所有集合
  rpc DropDatabase(DropDatabaseRequest) returns (google.protobuf.Empty);
  // 列出所有数据库
  rpc ListDatabases(ListDatabasesRequest) returns (ListDatabasesResponse);

  // --- 集合管理 ---
  // 在指定数据库中创建一个新的集合
  rpc CreateCollection(CreateCollectionRequest) returns (google.protobuf.Empty);
  // 删除一个集合
  rpc DropCollection(DropCollectionRequest) returns (google.protobuf.Empty);
  // 获取集合的元数据信息
  rpc GetCollectionInfo(GetCollectionInfoRequest) returns (CollectionInfo);
  // 列出指定数据库中的所有集合
  rpc ListCollections(ListCollectionsRequest) returns (ListCollectionsResponse);

  // --- 向量数据操作 ---
  // 插入预先计算好的向量（支持批量）
  rpc InsertVectors(InsertVectorsRequest) returns (google.protobuf.Empty);
  // 删除指定ID的向量（标记删除）
  rpc DeleteVectors(DeleteVectorsRequest) returns (DeleteVectorsResponse);
  // 根据向量进行相似度搜索
  rpc Search(SearchRequest) returns (SearchResponse);

  // --- 文本自动嵌入与操作 ---
  // 传入文本，自动调用 embedding API 后插入（支持批量）
  rpc EmbedAndInsert(EmbedAndInsertRequest) returns (google.protobuf.Empty);
  // 传入文本，自动调用 embedding API 后进行搜索
  rpc EmbedAndSearch(EmbedAndSearchRequest) returns (SearchResponse);
}


// ===================================
// 枚举与核心数据结构
// ===================================

// 距离度量类型
enum DistanceMetric {
  DISTANCE_METRIC_UNSPECIFIED = 0; // 未指定，将导致错误
  L2 = 1;                          // 欧氏距离
  COSINE = 2;                      // 余弦相似度
  INNER_PRODUCT = 3;               // 内积
}

// HNSW 算法的配置参数
message HnswConfig {
  int32 m = 1;                // 图中每个节点的最大连接数 (default: 16)
  int32 ef_construction = 2;  // 构建图时的搜索范围大小 (default: 200)
}

// 向量数据点
message Vector {
  string id = 1;                     // 向量的唯一ID
  repeated float elements = 2;       // 向量的浮点数表示
  google.protobuf.Struct metadata = 3; // 附加的 JSON 元数据
}

// 带有元数据的文本，用于自动嵌入
message TextWithMetadata {
  string id = 1;                       // 数据的唯一ID
  string text = 2;                     // 原始文本
  google.protobuf.Struct metadata = 3; // 附加的 JSON 元数据
}

// 搜索结果项
message SearchResultItem {
  Vector vector = 1; // 匹配到的向量（包含ID和元数据）
  float distance = 2; // 与查询向量的距离/相似度
}

// 集合的元数据信息
message CollectionInfo {
  string name = 1;                   // 集合名称
  int32 dimension = 2;               // 向量维度
  int64 vector_count = 3;            // 向量总数
  int64 deleted_count = 4;           // 标记删除的向量数
  int64 memory_bytes = 5;            // 预估内存占用 (in bytes)
  DistanceMetric metric_type = 6;    // 距离度量类型
  HnswConfig hnsw_config = 7;        // HNSW 配置
}


// ===================================
// 请求/响应消息
// ===================================

// --- 通用 ---
message AuthInfo {
  string password = 1; // 用于简单授权的密码
}

// --- 数据库 ---
message CreateDatabaseRequest {
  AuthInfo auth = 1;
  string name = 2;
}

message DropDatabaseRequest {
  AuthInfo auth = 1;
  string name = 2;
}

message ListDatabasesRequest {
  AuthInfo auth = 1;
}

message ListDatabasesResponse {
  repeated string names = 1;
}

// --- 集合 ---
message CreateCollectionRequest {
  AuthInfo auth = 1;
  string db_name = 2;
  string collection_name = 3;
  DistanceMetric metric_type = 4;
  optional HnswConfig hnsw_config = 5; // 创建时可选的 HNSW 参数
}

message DropCollectionRequest {
  AuthInfo auth = 1;
  string db_name = 2;
  string collection_name = 3;
}

message GetCollectionInfoRequest {
  AuthInfo auth = 1;
  string db_name = 2;
  string collection_name = 3;
}

message ListCollectionsRequest {
  AuthInfo auth = 1;
  string db_name = 2;
}

message ListCollectionsResponse {
  repeated CollectionInfo collections = 1;
}

// --- 向量操作 ---
message InsertVectorsRequest {
  AuthInfo auth = 1;
  string db_name = 2;
  string collection_name = 3;
  repeated Vector vectors = 4;
}

message DeleteVectorsRequest {
  AuthInfo auth = 1;
  string db_name = 2;
  string collection_name = 3;
  repeated string ids = 4;
}

message DeleteVectorsResponse {
  int32 deleted_count = 1; // 成功标记删除的数量
}

message SearchRequest {
  AuthInfo auth = 1;
  string db_name = 2;
  string collection_name = 3;
  repeated float query_vector = 4;
  int32 top_k = 5;
  optional int32 ef_search = 6; // HNSW 搜索时覆盖默认的 ef_search 参数
  // string filter = 7; // 预留给未来的元数据过滤
}

message SearchResponse {
  repeated SearchResultItem results = 1;
}

// --- 文本嵌入操作 ---
message EmbedAndInsertRequest {
  AuthInfo auth = 1;
  string db_name = 2;
  string collection_name = 3;
  repeated TextWithMetadata texts = 4;
  optional string embedding_model = 5; // 指定嵌入模型，如果未指定则使用服务器默认
}

message EmbedAndSearchRequest {
  AuthInfo auth = 1;
  string db_name = 2;
  string collection_name = 3;
  string query_text = 4;
  int32 top_k = 5;
  optional string embedding_model = 6;
  optional int32 ef_search = 7;
  // string filter = 8;
}

```

---

### 2. 服务端命令行工具参数 (`scintirete-server`)

该工具是启动数据库服务的唯一入口，设计力求简洁，主要依赖配置文件，同时提供关键参数的命令行覆盖。

```sh
# 启动 Scintirete 服务
# 用法: scintirete-server [OPTIONS]

# 示例:
# 1. 使用默认配置文件启动
scintirete-server

# 2. 指定配置文件路径
scintirete-server --config /etc/scintirete/config.toml

# 3. 覆盖配置文件中的 gRPC 端口和日志级别
scintirete-server -c ./scintirete.toml --grpc.port 9091 --log.level debug

# --- 参数列表 ---

# --config, -c
#   说明: 指定 TOML 配置文件的路径。
#   默认值: "scintirete.toml" (在当前工作目录下查找)
#   示例: --config /etc/scintirete.toml

# --grpc.host
#   说明: 覆盖配置文件中的 gRPC 服务监听地址。
#   默认值: (来自配置文件)
#   示例: --grpc.host 0.0.0.0

# --grpc.port
#   说明: 覆盖配置文件中的 gRPC 服务监听端口。
#   默认值: (来自配置文件)
#   示例: --grpc.port 9091

# --http.port
#   说明: 覆盖配置文件中的 HTTP (gRPC-Gateway) 服务监听端口。
#   默认值: (来自配置文件)
#   示例: --http.port 8081

# --data-dir
#   说明: 覆盖配置文件中的数据持久化目录（用于 RDB 和 AOF）。
#   默认值: (来自配置文件)
#   示例: --data-dir /var/lib/scintirete

# --log.level
#   说明: 覆盖配置文件中的日志级别。
#   可选值: "debug", "info", "warn", "error"
#   默认值: (来自配置文件)
#   示例: --log.level debug

# --version, -v
#   说明: 打印版本信息并退出。
```

---

### 3. 服务端 TOML 配置结构 (`scintirete.toml`)

这是唯一的配置文件，结构清晰，分块管理，易于理解和修改。

```toml
# Scintirete 默认配置文件

# [server] 表定义了网络服务和认证相关的配置
[server]
# gRPC 服务监听的主机地址
grpc_host = "127.0.0.1"
# gRPC 服务监听的端口
grpc_port = 9090

# HTTP/JSON 网关监听的主机地址 (通过 gRPC-Gateway 实现)
http_host = "127.0.0.1"
# HTTP/JSON 网关监听的端口
http_port = 8080

# 简单的密码列表授权。客户端请求中的 password 必须是列表中的一员。
# 为了安全，建议使用环境变量或 secrets management 工具来填充。
passwords = ["your-strong-password-here", "another-secret-key"]


# [log] 表定义了日志行为
[log]
# 日志级别: "debug", "info", "warn", "error"
level = "info"
# 日志格式: "text" (人类可读) 或 "json" (机器可读)
format = "json"
# 是否启用审计日志 (记录所有写操作)
enable_audit_log = true


# [persistence] 表定义了数据持久化策略
[persistence]
# 数据目录，用于存放 RDB 快照和 AOF 日志
data_dir = "./data"
# RDB 快照文件名
rdb_filename = "dump.rdb"
# AOF (Append-Only File) 日志文件名
aof_filename = "appendonly.aof"
# AOF 同步策略:
# "always": 每个写命令都立即同步到磁盘，最安全但最慢。
# "everysec": 每秒同步一次，性能和安全的良好折中（默认）。
# "no": 由操作系统决定何时同步，最快但最不安全。
aof_sync_strategy = "everysec"


# [embedding] 表定义了与外部文本嵌入服务交互的配置
[embedding]
# 符合 OpenAI `embeddings` 接口规范的 API base URL
base_url = "https://api.openai.com/v1/embeddings"
# API Token/Key。为了安全，强烈建议通过环境变量设置。
# 这里指定了要读取的环境变量名称。
api_key_env_var = "OPENAI_API_KEY"
# 每分钟请求数限制 (RPM)
rpm_limit = 3500
# 每分钟 Token 数限制 (TPM)
tpm_limit = 90000


# [observability] 表定义了可观测性相关的配置
[observability]
# 是否启用 Prometheus 指标接口
metrics_enabled = true
# Prometheus 指标接口的路径
metrics_path = "/metrics"
# Prometheus 指标服务的监听端口（通常与主服务分开）
metrics_port = 9100


# [algorithm] 表定义了索引算法的默认参数
[algorithm]
  # HNSW 算法的默认超参数
  [algorithm.hnsw_defaults]
  # 在创建集合时，如果没有指定，则使用这些值
  m = 16
  ef_construction = 200
  ef_search = 50
```

---

### 4. 客户端命令行工具参数 (`scintirete-cli`)

客户端工具采用 `command subcommand` 的风格，类似 `docker` 和 `git`，直观且易于脚本化。

```sh
# Scintirete 客户端命令行接口
# 用法: scintirete-cli [GLOBAL_OPTIONS] COMMAND SUBCOMMAND [ARGS]

# --- 全局选项 (Global Options) ---
# --host <address>
#   说明: Scintirete 服务器地址。
#   默认值: "localhost:9090"
#   示例: --host scintirete.prod.svc:9090

# -p, --password <password>
#   说明: 用于认证的密码。也可通过环境变量 SCINTIRETE_PASSWORD 设置。
#   示例: -p "your-strong-password-here"

# --json
#   说明: 以 JSON 格式输出结果，方便脚本处理。
#   示例: scintirete-cli --json db list


# --- 命令 (Commands) ---

# == 数据库管理 (db) ==
# scintirete-cli db create <db_name>
#   创建数据库。
# scintirete-cli db drop <db_name>
#   删除数据库。
# scintirete-cli db list
#   列出所有数据库。

# == 集合管理 (collection, coll) ==
# scintirete-cli collection create <db_name> <coll_name> --metric <L2|Cosine|InnerProduct> [--hnsw-m 16] [--hnsw-efc 200]
#   创建集合。--metric 是必须的。
# scintirete-cli collection drop <db_name> <coll_name>
#   删除集合。
# scintirete-cli collection info <db_name> <coll_name>
#   显示集合的详细信息。
# scintirete-cli collection list <db_name>
#   列出指定数据库中的所有集合。

# == 向量操作 (vector, vec) ==
# scintirete-cli vector insert <db_name> <coll_name> --id <id> --vector '[0.1, 0.2, ...]' --metadata '{"key":"val"}'
#   插入单个向量。
#   注意: --vector 和 --metadata 参数需要是合法的 JSON 字符串。
# scintirete-cli vector insert <db_name> <coll_name> --from-jsonl <filepath>
#   从 JSON Lines 文件批量插入向量。每行一个 JSON 对象，包含 "id", "elements", "metadata"。
# scintirete-cli vector delete <db_name> <coll_name> --id <id1> [--id <id2> ...]
#   删除一个或多个向量。
# scintirete-cli vector search <db_name> <coll_name> --vector '[0.3, 0.4, ...]' --top-k 5 [--efs 100]
#   搜索相似向量。--efs 覆盖集合的默认 ef_search。

# == 文本嵌入操作 (text) ==
# scintirete-cli text insert <db_name> <coll_name> --id <id> --text "Hello world" --metadata '{"source":"doc1"}' [--model <model_name>]
#   自动嵌入并插入单个文本。
# scintirete-cli text insert <db_name> <coll_name> --from-jsonl <filepath> [--model <model_name>]
#   从 JSON Lines 文件批量嵌入并插入文本。每行一个 JSON 对象，包含 "id", "text", "metadata"。
# scintirete-cli text search <db_name> <coll_name> --query "A question to search" --top-k 5 [--model <model_name>] [--efs 100]
#   自动嵌入查询文本并搜索。

# --- 示例 ---
# 1. 创建数据库和集合
scintirete-cli -p "secret" db create my_app
scintirete-cli -p "secret" collection create my_app articles --metric Cosine

# 2. 嵌入并插入文本
scintirete-cli -p "secret" text insert my_app articles --id "doc1" --text "Scintirete is a lightweight vector database." --metadata '{"author":"system"}'

# 3. 搜索
scintirete-cli -p "secret" text search my_app articles --query "What is Scintirete?" --top-k 3
```

这套设计方案紧密围绕您的需求文档，从数据契约到运维配置，再到用户交互，形成了一个完整且一致的体系。它在满足第一阶段核心功能的同时，也为未来的扩展（如新的算法、更复杂的过滤）留下了清晰的接口。