# 审计日志使用指南

## 概述

Scintirete 提供了简单而有效的审计日志功能，用于记录所有重要的数据库操作，满足合规和调试需求。

## 功能特性

### ✅ **已支持的操作**
- **数据库管理**: `CreateDatabase`, `DropDatabase`
- **集合管理**: `CreateCollection`, `DropCollection`
- **向量数据**: `InsertVectors`, `DeleteVectors`
- **辅助操作**: `EmbedAndInsert`

### 📝 **日志格式**
```json
{
  "timestamp": "2025-07-20T14:31:08.204977Z",
  "level": "OPERATION",
  "operation": "CreateDatabase",
  "database": "test_db",
  "collection": "test_coll",
  "user_id": "user_c638833",
  "success": true,
  "metadata": {
    "operation_type": "database_management",
    "vector_count": 100
  }
}
```

## 配置

### 启用审计日志
在配置文件中设置：
```toml
[server]
enable_audit_log = true
```

### 日志文件位置
审计日志自动保存在：
```
{data_dir}/audit.log
```

### 日志轮转
- **最大文件大小**: 10MB
- **保留文件数**: 5个
- **自动轮转**: 当文件超过限制时自动创建新文件

## 用户识别

系统使用密码哈希生成简化的用户标识：
- **格式**: `user_xxxxxxxx` (8位哈希)
- **隐私保护**: 不直接存储密码
- **唯一性**: 相同密码产生相同ID

## 元数据说明

### 数据库操作
```json
{
  "operation_type": "database_management"
}
```

### 集合操作
```json
{
  "operation_type": "collection_management",
  "metric_type": "L2",
  "hnsw_params": {...}
}
```

### 向量操作
```json
{
  "operation_type": "vector_data",
  "vector_count": 100,
  "requested_count": 50,
  "actual_deleted": 45
}
```

### 辅助操作
```json
{
  "operation_type": "auxiliary",
  "embedding_model": "text-embedding-ada-002",
  "text_count": 10,
  "vector_count": 10
}
```

## 最佳实践

1. **定期备份**: 审计日志包含重要的操作历史
2. **监控大小**: 关注日志文件增长，必要时调整轮转策略
3. **分析工具**: 可使用 `jq` 等工具分析 JSON 格式的日志
4. **合规需求**: 根据组织要求确定日志保留周期

## 示例查询

### 查看所有数据库操作
```bash
grep "database_management" audit.log | jq .
```

### 统计向量操作
```bash
grep "vector_data" audit.log | jq .vector_count | paste -sd+ | bc
```

### 查看特定用户操作
```bash
grep "user_c638833" audit.log | jq .
``` 