# 系统架构模式

## 核心组件架构

### 持久化系统
- **AOF Logger**: 实时命令日志记录，支持三种同步策略
  - `always`: 每个写命令立即同步到磁盘（最安全但最慢）
  - `everysec`: 每秒同步一次（默认，性能和安全的折中）
  - `no`: 智能同步，缓冲区≥4KB或每5分钟同步一次
- **RDB Manager**: 快照管理，默认每5分钟检查一次
- **后台任务**: 两个独立的 goroutine 处理 RDB 和 AOF 重写

### HNSW 向量索引
- **内存存储**: 所有向量数据和图结构存储在内存中
- **可配置参数**: 
  - `m = 16`: 每个节点的最大连接数
  - `ef_construction = 200`: 构建时的搜索候选数
  - `ef_search = 50`: 搜索时的候选数

### 服务器架构
- **gRPC 服务**: 主要 API 服务，默认端口 9090
- **HTTP Gateway**: HTTP/JSON 接口，默认端口 8080
- **指标服务**: Prometheus 指标，默认端口 9100

## 资源使用模式

### CPU 使用
1. **主服务进程**: gRPC/HTTP 请求处理
2. **AOF 后台同步**: 每秒或智能触发的磁盘 I/O
3. **RDB 快照任务**: 每5分钟检查，条件满足时执行
4. **AOF 重写任务**: 每5分钟检查，文件大小超过64MB时执行
5. **CPU 监控**: 持续监控系统资源使用

### 内存使用
1. **向量数据**: 直接存储在内存中
2. **HNSW 图结构**: 节点连接关系数据
3. **缓冲区**: AOF 写入缓冲区（默认6KB）
4. **Go 运行时**: GC 和 goroutine 开销

## 已知性能瓶颈
1. **磁盘 I/O**: AOF 同步和 RDB 快照
2. **内存压力**: 在小内存环境下的 GC 压力
3. **并发任务**: 多个后台任务同时运行
